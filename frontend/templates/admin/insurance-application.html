{% extends "admin/layout.html" %}

{% block title %}
    Insurance Application | AiGRI <Portal></Portal>
{% endblock %}

{% block extrastyles %} 
    <link rel="stylesheet" href="../../static/css/reg-farm.css">
{% endblock %}

{% block header_title %}
    Insurance Application System
{% endblock %}

{% block main %}
<div class="form-container">
    <h2 class="form-title">Verify RSBSA Farmer ID</h2>
    
    <div id="verify-rsbsa">
        <div class="form-group">
            <label for="rsbsa-id">RSBSA Farmer ID No.</label>
            <input type="text" id="rsbsa-id" name="rsbsa_id" placeholder="Enter RSBSA ID Number" required>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-login" id="rsbsa-confirm">Proceed</button>
        </div>
    </div>

</div>

<div class="loading-overlay" id="loading-overlay">
    <div class="loading-popup">
        <div class="loading-spinner"></div>
        <div class="loading-text">Fetching Data</div>
        <div class="loading-subtext">Please wait while we process your request...</div>
    </div>
</div>
<!-- PDF Preview Modal -->
<style>
.pdf-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 2000; }
.pdf-modal-backdrop{ position: absolute; inset: 0; background: rgba(0,0,0,0.6); }
.pdf-modal-content{ position: relative; background: #fff; width: 92%; max-width: 1000px; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 2001; display:flex; flex-direction:column; }
.pdf-modal-header{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid #eee; }
.pdf-modal-body{ padding:0; }
.pdf-modal-actions{ display:flex; justify-content:flex-end; gap:10px; padding:12px 16px; border-top:1px solid #eee; background:#fafafa; }
.btn-close{ background:none; border:none; font-size:1.5rem; line-height:1; cursor:pointer; }
.pdf-modal iframe{ width:100%; height:70vh; border:0; }
</style>
<div id="pdfModal" class="pdf-modal" aria-hidden="true">
    <div class="pdf-modal-backdrop" id="pdfModalBackdrop"></div>
    <div class="pdf-modal-content" role="dialog" aria-modal="true" aria-labelledby="pdfModalTitle">
        <div class="pdf-modal-header">
            <h3 id="pdfModalTitle">Preview Stamped PDF</h3>
            <button id="pdfModalClose" class="btn-close" aria-label="Close">&times;</button>
        </div>
        <div class="pdf-modal-body">
            <iframe id="pdfPreviewFrame" src="/static/assets/stamped-sample-method1.pdf"></iframe>
        </div>
        <div class="pdf-modal-actions">
            <button id="pdfModalCancel" type="button" class="btn btn-secondary">Cancel</button>
            <button id="pdfModalConfirm" type="button" class="btn btn-primary">Confirm & Submit</button>
        </div>
    </div>
</div>

<div class="form-container" id="insurance-container" style="display: none;">
    <div id="insurance-application">
        <h2 class="form-title">Application for Crop Insurance</h2>

        <div class="progress-bar">
            <div class="progress-bar-line"></div> 
            <div class="progress-step active" data-title="Application Details">1</div>
            <div class="progress-step" data-title="Farm Info">2</div>
        </div>
        
        <form action="/admin/insurance-application" method="post" id="insurance-application-form">
            <div class="form-step active">
                <h3 class="form-title" style="text-align: left; font-size: 1.2rem;">Application Details </h3>
                
                <div class="form-group">
                    <label for="application-type-select">Application Type</label>
                    <select id="application-type-select" name="application_type">
                        <option disabled selected>Application Type</option>
                        <option value="new">New Application</option>
                        <option value="renewal">Renewal</option>
                    </select>
                </div>

                <div class="form-group" id="farmer-selection-field" style="display: none;">
                    <label for="farmer-select">Select Farmer for Renewal</label>
                    <select id="farmer-select" name="farmer_id">
                        <option disabled selected>Select Farmer for Renewal</option>
                        <option value="1">Juan Dela Cruz - CIRS ID: 123456789</option>
                        <option value="2">Maria Santos - CIRS ID: 987654321</option>
                        <option value="3">Roberto Garcia - CIRS ID: 456789123</option>
                        <option value="4">Luzviminda Reyes - CIRS ID: 321654987</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="crop-type-select">Crop Type</label>
                    <select id="crop-type-select" name="crop_type">
                        <option disabled selected>Crop Type</option>
                        <option value="rice">Rice</option>
                        <option value="corn">Corn</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="financing-method-select">Financing Method</label>
                    <select id="financing-method-select" name="financing_method">
                        <option disabled selected>Financing Method</option>
                        <option value="self-financed">Self-financed</option>
                        <option value="borrowing">Borrowing</option>
                    </select>
                </div>
                <div class="form-group" id="lender-field" style="display: none;">
                        <label for="lender-name">Lender</label>
                        <input type="text" id="lender-name" name="lender_name" placeholder="Enter lender's name">
                </div>
            </div>
            <div class="form-step">
                <h3 class="form-title" style="text-align: left; font-size: 1.2rem;">The Farm <br><small>B.1 - B.3</small></h3>
                <div class="farm-lot">
                    <h4>Farm Lot 1</h4>
                    <div class="form-group">
                        <label>B.1 Farm Location</label>
                        <div class="form-row">
                            <input type="text" name="farm_sitio_1" placeholder="Sitio">
                            <input type="text" name="farm_barangay_1" placeholder="Barangay" required>
                            <input type="text" name="farm_municipality_1" placeholder="Municipality" required>

                            <input type="text" name="farm_province_1" placeholder="Province" value="Leyte" disabled required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>B.2 Boundaries</label>
                        <div class="form-row">
                            <input type="text" name="farm_north_1" placeholder="North" required>
                            <input type="text" name="farm_south_1" placeholder="South" required>
                            <input type="text" name="farm_east_1" placeholder="East" required>
                            <input type="text" name="farm_west_1" placeholder="West" required>
                        </div>
                    </div>
                    <div class="form-group" id="b3-variety">
                        <label for="variety_1">B.3 Variety</label>
                        <input type="text" id="variety_1" name="farm_variety_1" placeholder="Variety" required>
                    </div>
                </div>
            </div>
            <div class="form-actions" style="justify-content: space-between;">
                <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">Previous</button>
                <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
            </div>
        </form>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const formSteps = document.querySelectorAll('.form-step');
    const progressSteps = document.querySelectorAll('.progress-step');
    const progressBarLine = document.querySelector('.progress-bar-line');
    
    const applicationTypeSelect = document.getElementById('application-type-select');
    const farmerSelectionField = document.getElementById('farmer-selection-field');
    const financingMethodSelect = document.getElementById('financing-method-select');
    const lenderField = document.getElementById('lender-field');
    const verifyRSBSA = document.getElementById('verify-rsbsa');
    const loadingOverlay = document.getElementById('loading-overlay');
    const rsbsaConfirm = document.getElementById('rsbsa-confirm');
    const insContainer = document.getElementById('insurance-container');

    let currentStep = 0;

    rsbsaConfirm.addEventListener('click', function(e) {
        e.preventDefault();
        
        loadingOverlay.style.display = 'flex';
        
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
            
            verifyRSBSA.closest('.form-container').style.display = 'none';

            if (insContainer) insContainer.style.display = 'block';

            alert('RSBSA ID verified successfully! Proceed with the application.');
        }, 500);
    });
    
    nextBtn.addEventListener('click', () => {
        if (currentStep < formSteps.length - 1) {
            currentStep++;
            updateFormSteps();
        } else {
            // open PDF preview modal instead of direct submit
            if (typeof window.showPdfModal === 'function') {
                window.showPdfModal();
            } else {
                document.getElementById('insurance-application-form').submit();
            }
        }
    });

    prevBtn.addEventListener('click', () => {
        if (currentStep > 0) {
            currentStep--;
            updateFormSteps();
        }
    });

    applicationTypeSelect.addEventListener('change', function() {
        if (this.value === 'renewal') {
            farmerSelectionField.style.display = 'block';
        } else {
            farmerSelectionField.style.display = 'none';
        }
    });

    financingMethodSelect.addEventListener('change', function() {
        if (this.value === 'borrowing') {
            lenderField.style.display = 'block';
        } else {
            lenderField.style.display = 'none';
        }
    });
    
    function updateFormSteps() {
        formSteps.forEach((step, index) => {
            step.classList.toggle('active', index === currentStep);
        });
        updateButtons();
        updateProgressBar();
    }

    function updateButtons() {
        prevBtn.style.display = currentStep === 0 ? 'none' : 'inline-block';
        nextBtn.textContent = currentStep === formSteps.length - 1 ? 'Submit' : 'Next';
    }

    function updateProgressBar() {
        progressSteps.forEach((step, index) => {
            step.classList.toggle('active', index <= currentStep);
        });

        const activeSteps = document.querySelectorAll('.progress-step.active');
        const width = ((activeSteps.length - 1) / (progressSteps.length - 1)) * 100;
        progressBarLine.style.width = width + '%';
    }
    
    updateFormSteps();
});
</script>

<script>
// Intercept form submit to show PDF preview modal
(function(){
    var form = document.getElementById('insurance-application-form');
    var pdfModal = document.getElementById('pdfModal');
    var pdfBackdrop = document.getElementById('pdfModalBackdrop');
    var pdfClose = document.getElementById('pdfModalClose');
    var pdfCancel = document.getElementById('pdfModalCancel');
    var pdfConfirm = document.getElementById('pdfModalConfirm');

    function openModal() {
        pdfModal.style.display = 'flex';
        pdfModal.setAttribute('aria-hidden','false');
        // trap focus briefly
        pdfConfirm.focus();
    }

    function closeModal() {
        pdfModal.style.display = 'none';
        pdfModal.setAttribute('aria-hidden','true');
    }

    // intercept submit
    form.addEventListener('submit', function(e){
        // if modal already open allow submit
        if (pdfModal.getAttribute('aria-hidden') === 'false') return true;

        e.preventDefault();
        openModal();
    });

    // wire close/cancel
    pdfBackdrop.addEventListener('click', closeModal);
    pdfClose.addEventListener('click', closeModal);
    pdfCancel.addEventListener('click', closeModal);

    // confirm -> submit form programmatically
    pdfConfirm.addEventListener('click', function(){
        closeModal();
        form.submit();
    });

    // expose a convenience method to open the modal (used by the next button)
    window.showPdfModal = function() {
        openModal();
    };
})();
</script>

{% endblock %}


