{% extends "admin/layout.html" %}

{% block title %}
    Damage Assessment | AiGRI Portal
{% endblock %}

{% block header_title %}
    Damage Assessment
{% endblock %}

{% block main %}
    <div class="form-container">
        <h2 class="form-title">Initiate New Assessment</h2>
        
        <form id="damage-assessment-form" action="/admin/damage-assessment" method="POST" enctype="multipart/form-data">
            <div class="form-row">
                <div class="form-group">
                    <label for="farmer-select">Select Farmer</label>
                    <select id="farmer-select" name="farmer_id" required>
                        <option disabled selected>Select farmer</option>
                        <option value="1">Juan Dela Cruz - RSBSA ID No.: 123456789</option>
                        <option value="2">Maria Santos - RSBSA ID No.: 987654321</option>
                        <option value="3">Roberto Garcia - RSBSA ID No.: 456789123</option>
                        <option value="4">Luzviminda Reyes - RSBSA ID No.: 321654987</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="disaster-type">Disaster Type</label>
                    <select id="disaster-type" name="disaster_type" required>
                        <option disabled selected>Select disaster</option>
                        <option value="typhoon">Typhoon</option>
                        <option value="drought">Drought</option>
                        <option value="flood">Flood</option>
                        <option value="pest">Pest Infestation</option>
                        <option value="disease">Crop Disease</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
                
            <div class="form-group">
                <label for="disaster-date">Date of Disaster</label>
                <input type="date" id="disaster-date" name="disaster_date" required>
            </div>

            <div class="form-group">
                <label>Post Disaster Images</label>
                <input type="file" id="after-images" name="after_images" multiple accept="image/*" required>
            </div>
            
            <div class="form-group">
                <label>Farm Boundary</label>
                <div class="map-container" id="damage-map">
                    <img id="farm-boundary-img" src="{{ url_for('static', filename='/assets/test_input/farm1.png') }}" alt="Farm Boundary" style="width: 100%; height: 100%; object-fit: contain; border: 1px solid #ddd; border-radius: 4px; display: none;">
                </div>
            </div>
            
            <input type="hidden" id="boundary-coords" name="boundary_coords" value='[{"lat":12.8797,"lng":121.774},{"lat":12.8807,"lng":121.775},{"lat":12.8817,"lng":121.773},{"lat":12.8807,"lng":121.772}]'>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit for Assessment</button>
            </div>
        </form>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="loading-container">
                <div class="spinner"></div>
                <h3>Processing Assessment...</h3>
                <p>AI is analyzing the farmland damage</p>
            </div>
        </div>
    </div>

    <!-- Assessment Report Modal -->
    <div id="reportModal" class="modal" style="display: none;">
        <div class="modal-content report-modal">
            <div class="modal-header">
                <h2>Damage Assessment Report</h2>
                <span class="close" onclick="closeReportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="report-section">
                    <h3>Farm Information</h3>
                    <div class="info-grid">
                        <div><strong>Farmer:</strong> <span id="report-farmer"></span></div>
                        <div><strong>Disaster Type:</strong> <span id="report-disaster"></span></div>
                        <div><strong>Date:</strong> <span id="report-date"></span></div>
                        <div><strong>Assessment ID:</strong> <span id="report-id">ASS-2025-001</span></div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>Damage Analysis</h3>
                    <div class="damage-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="stat-healthy">0%</div>
                            <div class="stat-label">Healthy Area</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-partial">0%</div>
                            <div class="stat-label">Partially Damaged</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-full">0%</div>
                            <div class="stat-label">Fully Damaged</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>Damage Map</h3>
                    <div class="damage-map-container">
                        <img id="damage-map-result" src="{{ url_for('static', filename='assets/output/damage_map_only.png') }}" alt="Damage Map" style="width: 100%; max-height: 400px; object-fit: contain; border: 1px solid #ddd;">
                    </div>
                </div>

                <div class="report-section">
                    <h3>Recommendations</h3>
                    <ul class="recommendations">
                        <li>Immediate replanting recommended for severely damaged areas</li>
                        <li>Soil testing advised before next planting cycle</li>
                        <li>Consider crop insurance claim for affected areas</li>
                        <li>Implement drainage improvements to prevent future flood damage</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveReport()">Save Report</button>
                <button class="btn btn-primary" onclick="exportToPDF()">Export as PDF</button>
                <button class="btn btn-secondary" onclick="closeReportModal()">Close</button>
            </div>
        </div>
    </div>

    <style>
        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .report-modal {
            width: 800px;
            max-width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        /* Loading Animation */
        .loading-container {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Report Styles */
        .report-section {
            margin-bottom: 25px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .damage-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            min-width: 120px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .damage-map-container {
            margin-top: 15px;
            text-align: center;
        }

        .recommendations {
            margin-top: 10px;
            padding-left: 20px;
        }

        .recommendations li {
            margin-bottom: 8px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }
    </style>

    <script>
        // Store form data for the report
        let assessmentData = {};

        // Initialize form on page load
        document.addEventListener('DOMContentLoaded', function() {
            
            // Get the farm boundary image element
            const farmBoundaryImg = document.getElementById('farm-boundary-img');

            if (farmBoundaryImg) {
                farmBoundaryImg.style.display = 'none';
                console.log('Farm boundary hidden on page load');
            }
            
            // Set default date to today
            const dateInput = document.getElementById('disaster-date');
            if (dateInput) {
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0];
                dateInput.value = formattedDate;
                console.log('Default date set to:', formattedDate);
            }
            
            // Handle form submission with AJAX
            const form = document.getElementById('damage-assessment-form');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validate form
                if (!validateForm(form)) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                // Store assessment data for report display
                assessmentData = {
                    farmerId: document.getElementById('farmer-select').value,
                    farmerText: document.querySelector('#farmer-select option:checked').textContent,
                    disasterType: document.getElementById('disaster-type').value,
                    disasterText: document.querySelector('#disaster-type option:checked').textContent,
                    disasterDate: document.getElementById('disaster-date').value
                };
                
                try {
                    // Show loading modal
                    showLoadingModal();
                    
                    // Create FormData object to send files
                    const formData = new FormData(form);
                    
                    // Submit form via AJAX
                    const response = await fetch('/admin/damage-assessment', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        // Wait a bit to ensure processing is complete
                        setTimeout(() => {
                            hideLoadingModal();
                            showAssessmentReport();
                        }, 1000);
                    } else {
                        throw new Error('Server error');
                    }
                    
                } catch (error) {
                    console.error('Error submitting assessment:', error);
                    hideLoadingModal();
                    alert('Error submitting assessment. Please try again.');
                }
            });

            // Handle image uploads
            document.getElementById('after-images').addEventListener('change', function() {
                console.log('After images change event triggered');
                console.log('Files selected:', this.files);
                
                // Show farm boundary when images are uploaded
                if (this.files && this.files.length > 0) {
                    if (farmBoundaryImg) {
                        farmBoundaryImg.style.display = 'block';
                        console.log('Farm boundary displayed - image uploaded');
                    }
                } else {
                    if (farmBoundaryImg) {
                        farmBoundaryImg.style.display = 'none';
                        console.log('Farm boundary hidden - no image');
                    }
                }
            });
        });
 
        // Modal Functions
        function showLoadingModal() {
            document.getElementById('loadingModal').style.display = 'flex';
            console.log('Loading modal shown');
        }

        function hideLoadingModal() {
            document.getElementById('loadingModal').style.display = 'none';
            console.log('Loading modal hidden');
        }

        function showAssessmentReport() {
            // Populate report with stored data
            document.getElementById('report-farmer').textContent = assessmentData.farmerText;
            document.getElementById('report-disaster').textContent = assessmentData.disasterText;
            document.getElementById('report-date').textContent = assessmentData.disasterDate;
            
            // Update statistics (these would come from backend in real implementation)
            document.getElementById('stat-healthy').textContent = '16.77%';
            document.getElementById('stat-partial').textContent = '56.25%';
            document.getElementById('stat-full').textContent = '30.57%';
            
            // Force reload the damage map image with cache busting
            const damageMapImg = document.getElementById('damage-map-result');
            const timestamp = new Date().getTime();
            damageMapImg.src = damageMapImg.src.split('?')[0] + '?t=' + timestamp;
            
            // Show report modal
            document.getElementById('reportModal').style.display = 'flex';
            console.log('Assessment report shown');
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
            console.log('Report modal closed');
        }

        function exportToPDF() {
            alert('Exporting report as PDF...');
            console.log('PDF export initiated');
            
            // Trigger browser's print dialog which allows saving as PDF
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function saveReport() {
            alert('Report saved successfully!');
            console.log('Save report initiated');
            // In production, send report data to backend for storage
        }

        function validateForm(form) {
            let isValid = true;
            
            // Check required fields
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value || (field.type === 'file' && field.files.length === 0)) {
                    field.style.borderColor = 'red';
                    isValid = false;
                } else {
                    field.style.borderColor = '';
                }
            });
            
            return isValid;
        }
    </script>

{% endblock %}